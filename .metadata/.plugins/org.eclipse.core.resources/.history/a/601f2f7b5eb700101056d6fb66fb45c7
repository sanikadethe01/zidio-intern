package com.zidio.controller;

import com.zidio.model.JobApplication;
import com.zidio.repository.ApplicationRepository;
import com.zidio.repository.JobRepository;
import com.zidio.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/api/applications")
@RequiredArgsConstructor
public class ApplicationController {
  private final ApplicationRepository appRepo;
  private final JobRepository jobRepo;
  private final UserRepository userRepo;

  @PostMapping("/apply")
  public ResponseEntity<?> apply(@RequestHeader("X-USER-ID") Long studentId,
                                 @RequestParam Long jobId) {
    var userOpt = userRepo.findById(studentId);
    if (userOpt.isEmpty()) return ResponseEntity.badRequest().body("Invalid user");
    var jobOpt = jobRepo.findById(jobId);
    if (jobOpt.isEmpty()) return ResponseEntity.badRequest().body("Invalid jobId");

    JobApplication app = JobApplication.builder()
        .jobId(jobId)
        .studentId(studentId)
        .studentName(userOpt.get().getName())
        .status("APPLIED")
        .build();
    return ResponseEntity.ok(appRepo.save(app));
  }

  @GetMapping("/by-student/{studentId}")
  public List<JobApplication> byStudent(@PathVariable Long studentId){
    return appRepo.findByStudentId(studentId);
  }

  @GetMapping("/by-job/{jobId}")
  public List<JobApplication> byJob(@PathVariable Long jobId){
    return appRepo.findByJobId(jobId);
  }

  @PostMapping("/{id}/update-status")
  public ResponseEntity<?> updateStatus(@PathVariable Long id, @RequestParam String status){
    var opt = appRepo.findById(id);
    if (opt.isEmpty()) return ResponseEntity.notFound().build();
    var app = opt.get();
    app.setStatus(status);
    return ResponseEntity.ok(appRepo.save(app));
  }
}
